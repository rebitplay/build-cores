<html>

<head>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: white;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #game-canvas {
      border: 1px solid black;
    }

    .toolbar {
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <div class="toolbar">
    <button type="button" id="launch-button">Launch</button>
    <button type="button" id="toggle-menu">Toggle Menu</button>
    <button type="button" id="pause-button">Pause toggle</button>
    <button type="button" id="ff-button">Fast Forward</button>
    <button type="button" id="speed2x-button">2x</button>
    <button type="button" id="speed4x-button">4x</button>
    <button type="button" id="speed6x-button">6x</button>
    <button type="button" id="speed8x-button">8x</button>
    <fieldset>
      <button type="button" id="get-config-button">Get config</button>
      <input type="text" id="config-input" placeholder="Enter config key">
    </fieldset>
  </div>

  <div class="container">
    <canvas id="game-canvas"></canvas>
  </div>

  <script type="module">
    import { Nostalgist } from './nostalgist.js'

    let game = null;
    let module = null;
    let started = false
    let preparePromise = null

    function getLaunchOptions() {
      return {
        core: 'dosbox_pure',
        rom: '/roms/DOOM1993.zip',
        resolveCoreJs(core, options) {
          return `/${core}_libretro.js`
        },
        resolveCoreWasm(core, options) {
          return `/${core}_libretro.wasm`
        },
        element: document.getElementById('game-canvas'),
        style: {
          position: 'relative',
          width: '600px',
          height: '400px',
        },
        retroarchConfig: {
          // video_vsync: false,
          // video_swap_interval: 0,
          // video_shader_enable: false,
          // audio_mute_enable: true,
          // audio_mixer_mute_enable: true,
          // fps_show: true
        },
        retroarchCoreConfig: {
        },
      }
    }

    async function prepareGame() {
      if (!preparePromise) {
        preparePromise = Nostalgist.prepare(getLaunchOptions())
      }
      game = await preparePromise
      return game
    }

    async function startGame() {
      await prepareGame()
      if (started) return

      await game.start()
      started = true

      console.log('game', game)
      module = game.getEmscriptenModule();
      console.log('module', module)
    }

    prepareGame()

    document.getElementById('launch-button').addEventListener('click', async () => {
      await startGame()
    })

    function bindEvents() {
      document.getElementById('pause-button').addEventListener('click', () => {
        if (!started) return
        game.sendCommand('PAUSE_TOGGLE')
      })

      document.getElementById('ff-button').addEventListener('click', () => {
        if (!started) return
        game.sendCommand('FAST_FORWARD')
      })

      document.getElementById('speed2x-button').addEventListener('click', () => {
        if (!started) return
        module._cmd_set_fastforward_ratio(2.0)
      })

      document.getElementById('speed4x-button').addEventListener('click', () => {
        if (!started) return
        module._cmd_set_fastforward_ratio(4.0)
      })

      document.getElementById('speed6x-button').addEventListener('click', () => {
        if (!started) return
        module._cmd_set_fastforward_ratio(6.0)
      })

      document.getElementById('speed8x-button').addEventListener('click', () => {
        if (!started) return
        module._cmd_set_fastforward_ratio(8.0)
      })

      document.getElementById('get-config-button').addEventListener('click', () => {
        if (!started) return
        const configKey = document.getElementById('config-input').value
        const configValue = game.sendCommand('GET_CONFIG ' + configKey)
        console.log('configValue', configValue)
      })

      document.getElementById('toggle-menu').addEventListener('click', () => {
        if (!started) return
        game.sendCommand('MENU_TOGGLE')
      })
    }

    bindEvents()
  </script>
</body>

</html>
